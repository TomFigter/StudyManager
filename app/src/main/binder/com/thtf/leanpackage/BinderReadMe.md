Binder解析
|__Binder如何精确制导,找到目标Binder实体,并唤醒进程或者线程




  一、Binder如何精确制导,找到目标Binder实体,并唤醒进程或者线程
     |
     |->Binder实体服务有两种
     |  |__通过addService注册到ServiceManager中的服务,即系统服务.
     |  |  |__ActivityManagerService
     |  |  |__PackageManagerService
     |  |  |__PowerManagerService
     |  |__通过bindService拉起的服务,即开发者自己实现的服务.
     |  |  |_Activity
     |  |  |_Service
     |  |  |_Broadcast Receiver
     |  |  |_Content Provide                    
     |
     |->Binder定向制导的关键时理解Binder的四棵红黑树
     -----------------------------------------------------------------------------------------------  
  二、Binder底层册原理
     |   
     |->Binder如何只用一次内存拷贝就实现进程间通信的?
     |  |_Binder借助了内存映射的方法,在内核空间和接收方用户空间的数据缓存之间做了一层内存映射.即从发送方用户空间
     |  |_拷贝到内核空间缓存区数据,相当于直接拷贝到接收方用户空间的数据缓存区,从而减少了一次拷贝.
     |----------------------------------------------------------------------------------------------
     |->发起请求进程属于Client,接收请求的进程属于Server;由于存在进程隔离,双方不能通信;Binder如何实现通信的?
     |  |->Binder中定义了4个角色
     |  |  |_Client 请求方进程
     |  |  |_Server 接收方进程
     |  |  |_Binder驱动 通信桥梁 ->负责将Client请求转发到具体的Server中执行,并将Server返回的数据回传给Client
     |  |  |_ServiceManager DNS服务器 ->负责将Client请求的Binder描述符转化为具体的Server地址,以便Binder驱动
     |  |  |_               -> 能够转发给具体的Server.Server如需提供Binder服务,需向ServiceManager注册.
     |  |
     |  |->具体通信过程
     |  |  |_Server向ServiceManager注册
     |  |  |_Client向ServiceManager请求Server的Binder引用
     |  |  |_向具体的Server发送请求
     |  |  |_Server返回结果
     -----------------------------------------------------------------------------------------------
  三、Binder IPC实现原理
     |
     |->通信过程
     |  |_1.Binder驱动在内核空间创建一个数据接收缓存区
     |  |_2.在内核空间开辟一块内存缓存区;建立 "内核缓存区" 和 "内核中数据接收缓存区" 之间的映射关系,以及内核中
     |  |__ "数据接收缓存区" 和 "接收进程用户空间地址" 的映射关系.
     |  |_3.发送方进程通过系统调用 copy_from_user() 将数据copy到内核中内核缓存区,由于"内核缓存区"和"接收进程
     |  |__ 的用户空间"存在内存映射,因此也就相当于把数据发送到了"接收进程的用户空间",即完成了一次进程间通信
     |----------------------------------------------------------------------------------------------
     |->Binder通信中的代理模式
     |  |->A进程想要B进程中某个对象Object如何实现?
     |  |  |_1.在跨进程通信过程中都有Binder驱动的参与.因此数据流经Binder驱动时会对数据做一层转换;A进程想获取B
     |  |  |__ 进程中的Object时,Binder驱动不会真把Object返回给A,而是返回一个跟Object看起来一样的代理对象
     |  |  |__ ObjectProxy,ObjectProxy和Object一摸一样的方法,但这些方法并没有B进程中Object那些方法的能力,
     |  |  |__ 这些方法只需要把请求参数交给驱动即可.对于A进程来说和直接调用Object中的方法是一样的.
     |  |  |_2.当Binder驱动接收到A进程的消息后,发现这是ObjectProxy对象就会去查询"自己维护的表单"发现这是B进程
     |  |  |__ Object的代理对象.就去通知B进程调用Object方法,并要求B进程把返回的结果发给自己;当驱动拿到B进程的
     |  |  |__ 返回结果后就会转发给A进程,通信完成.
     -----------------------------------------------------------------------------------------------
     
----------------------------------------------------------------------------------------------------                      
      |-------------| \                                                                            
      |-mmap()返回值-|  \                                                                           
      |             |   \           |-------------|               |-------------|      
      |-------------| \  \          |||||||||||||||               |||||||||||||||    
      |||||||||||||||  \ / *------->|-------------|<--------\     |-------------|>>>>>>>>>>>   
      |||||||||||||||   X           |             |          \    |             |           |
      |||||||||||||||  / \          |             |           \   |-------------|           |    
      |-------------|-/   X-------> |-------------| <------- \ \  |||||||||||||||     copy_from_user    
      |             |    /          |||||||||||||||           \ \ |||||||||||||||           |    
    binder_proc->buffer /           |||||||||||||||            \ \|-------------|           |    
      |             |  /            |||||||||||||||             \ binder_proc->buffer <<<<<<<    
      |-------------|-/             |-------------|              \|-------------|    
        线程B内存空间                     物理空间                    进程A内存空间
----------------------------------------------------------------------------------------------------
     
     
     
     
  四、EventBus通信原理                                                                                                                   